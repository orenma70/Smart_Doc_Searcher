# 1. One-Time Setup: Create the repository in the cloud
aws ecr create-repository --repository-name smart-doc-api --region ap-southeast-2

# 2. Build and Upload: The "Daily Debug" sequence
# This builds your 'amazon_search_core.py' into a Docker image
docker build -t smart-doc-api .

# Login to AWS (replace the account ID if yours is different)
aws ecr get-login-password --region ap-southeast-2 | docker login --username AWS --password-stdin 038715112888.dkr.ecr.ap-southeast-2.amazonaws.com

# Tag and Push the image to the cloud registry
docker tag smart-doc-api:latest 038715112888.dkr.ecr.ap-southeast-2.amazonaws.com/smart-doc-api:latest
docker push 038715112888.dkr.ecr.ap-southeast-2.amazonaws.com/smart-doc-api:latest

# 3. Launch: Create the App Runner Service
# This command gives you a public URL and enables automatic updates
aws apprunner create-service `
  --service-name smart-doc-searcher-api `
  --source-configuration '{
    "AuthenticationConfiguration": { "AccessRoleArn": "arn:aws:iam::038715112888:role/service-role/AppRunnerECRAccessRole" },
    "AutoDeploymentsEnabled": true,
    "ImageRepository": {
      "ImageIdentifier": "038715112888.dkr.ecr.ap-southeast-2.amazonaws.com/smart-doc-api:latest",
      "ImageRepositoryType": "ECR",
      "ImageConfiguration": { "Port": "80" }
    }
  }' `
  --region ap-southeast-2