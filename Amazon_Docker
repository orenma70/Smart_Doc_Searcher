# Use a slim version to keep the image small and fast
FROM python:3.11-slim-bullseye

# AWS App Runner typically listens on 8080, but we make it flexible
ENV PORT 8080
ENV PYTHONUNBUFFERED True

# 1. Install necessary build tools
# slim-bullseye needs these for some python libraries (like C-extensions)
RUN apt-get update && apt-get install -y \
    gcc \
    libc-dev \
    libffi-dev \
    && rm -rf /var/lib/apt/lists/*

# 2. Set working directory
WORKDIR /app

# 3. Copy requirements and install
# Ensure boto3 is inside your requirements.txt!
COPY amazon_requirements.txt
RUN pip install --no-cache-dir -r amazon_requirements.txt

# 4. Copy your application files
COPY amazon_setup.txt .
COPY amazon_search_core.py .
COPY config_reader.py .
COPY document_parsers.py .
COPY amazon_search_utilities.py .

# 5. Start Gunicorn
# We use --timeout to ensure Gemini processing doesn't get cut off
CMD exec gunicorn --bind 0.0.0.0:$PORT --workers 1 --threads 8 --timeout 0 amazon_search_core:app